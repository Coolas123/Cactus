@model SettingViewModel
<h1>Settings</h1>
<div>
    @if (User.IsInRole("Author")){
    @await Component.InvokeAsync("BannerPath",new{id=Convert.ToInt32(User.FindFirst("Id").Value),html="id=\"myBanner\""})
    }
</div>
<div class="container">
    <div class="row">
        <div class="col d-flex flex-column align-items-end">
            <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <button class="btn btn-outline-secondary active m-1" id="v-pills-profile-tab" data-bs-toggle="pill" data-bs-target="#v-pills-profile" type="button" role="tab" aria-controls="v-pills-profile" aria-selected="true">Профиль</button>
                @if (User.IsInRole("Patron")){
                    <button class="btn btn-outline-secondary m-1" id="v-pills-registerAuthor-tab" data-bs-toggle="pill" data-bs-target="#v-pills-registerAuthor" type="button" role="tab" aria-controls="v-pills-registerAuthor" aria-selected="true">Стать автором</button>
                }
                @if (User.IsInRole("User")) {
                    <button class="btn btn-outline-secondary m-1" id="v-pills-UninterestingAuthors-tab" data-bs-toggle="pill" data-bs-target="#v-pills-UninterestingAuthors" type="button" role="tab" aria-controls="v-pills-UninterestingAuthors" aria-selected="true">Список неинтересного</button>
                }
                @if (User.IsInRole("Author")){
                    <button class="btn btn-outline-secondary m-1" id="v-pills-Monetization-tab" data-bs-toggle="pill" data-bs-target="#v-pills-Monetization" type="button" role="tab" aria-controls="v-pills-Monetization" aria-selected="true">Настройка монетизации</button>
                    <button class="btn btn-outline-secondary m-1" id="v-pills-Wallet-tab" data-bs-toggle="pill" data-bs-target="#v-pills-Wallet" type="button" role="tab" aria-controls="v-pills-Wallet" aria-selected="true">Настройка кошелька</button>
                }
            </div>
        </div>

        <div class="col flex-column d-flex align-items-start">
            <div class="tab-content" id="v-pills-tabContent">
                <div class="tab-pane fade show active" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab">
                    <form asp-action="ChangeSettings" asp-controller="Setting" method="post" enctype="multipart/form-data">
                        <div>
                            @await Component.InvokeAsync("AvatarPath", new { id = Convert.ToInt32(User.FindFirst("Id").Value), html = "id=\"myImage\" class=\"avatar\""})
                            <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('avatar').click()">Изменить аватарку</button>
                            <input type='file' id="avatar" style="display:none" asp-for="AvatarFile">
                        </div>
                        @if (User.IsInRole("Author")) {
                            <div> 
                                <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('banner').click()">Изменить баннер</button>
                                <input type='file' id="banner" style="display:none" asp-for="BannerFile">
                            </div>
                        }
                        <div>
                            <label asp-for="UserName"></label>
                            <input class="form-control" asp-for="UserName" value="@Model.User.UserName" />
                        </div>
                        <div>
                            <label asp-for="Email"></label>
                            <input class="form-control" asp-for="Email" value="@Model.User.Email" />
                        </div>
                        <div>
                            <label asp-for="DateOfBirth"></label>
                            <input class="form-control" asp-for="DateOfBirth" value="@Model.User.DateOfBirth.ToString("yyyy-MM-dd")" />
                        </div>
                        <div>
                            <label asp-for="Password"></label>
                            <input class="form-control" asp-for="Password" placeholder="Введите новый пароль" />
                        </div>
                        <div>
                            <label asp-for="ConfirmPassword"></label>
                            <input class="form-control" asp-for="ConfirmPassword" placeholder="Повторите пароль" />
                        </div>
                        <button class="btn btn-danger" type="submit">Сохранить</button>
                    </form>
                </div>

                <div class="tab-pane fade" id="v-pills-registerAuthor" role="tabpanel" aria-labelledby="v-pills-registerAuthor-tab">
                    <form asp-controller="setting" asp-action="RegisterAuthor" method="post">
                        <div asp-validation-summary="All" class="text-danger"></div>
                        <div class="d-flex form-control">
                            <input class="form-control-plaintext" value="www.cactus.ru/" readonly style="text-align:right" />
                            <input class="form-control-plaintext" asp-for="@Model.RegisterAuthor.UrlPage" placeholder="Адрес страницы" />
                        </div>
                        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">Стать автором</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <h3>Вы согласны стать автором?</h3>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Нет</button>
                                        <button type="submit" class="btn btn-success">Да</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-danger m-1" data-bs-toggle="modal" data-bs-target="#exampleModal">
                                Стать автором
                            </button>
                        </div>
                    </form>
                </div>

                <div class="tab-pane fade" id="v-pills-UninterestingAuthors" role="tabpanel" aria-labelledby="v-pills-UninterestingAuthors-tab">
                    <div>
                        <table class="table">
                            <tbody>
                                @if (Model.PagingUninterestingAuthors?.UninterestingAuthors != null) {
                                    @foreach (var p in Model.PagingUninterestingAuthors.UninterestingAuthors) {
                                        <tr>
                                            <td>@p.User.UserName</td>
                                            <td><a class="btn btn-primary" asp-controller="Author" asp-action="Index" asp-route-UrlPage="@p.Author.UrlPage">Профиль</a></td>
                                            <td><a class="btn btn-danger" asp-controller="Setting" asp-action="RemoveUninterestingAuthor" asp-route-authorId="@p.AuthorId">Убрать</a></td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                        <div page-model="@Model.PagingUninterestingAuthors?.PagingInfo" page-action="Index" type-page="UninterestingAuthorsPage"
                             page-classes-enabled="true" page-class="btn" page-class-normal="btn-outline-dark"
                             page-class-selected="btn-primary" class="btn-group pull-right m-1">
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="v-pills-Monetization" role="tabpanel" aria-labelledby="v-pills-Monetization-tab">
                    <form asp-action="AddSubLevel" asp-controller="Monetization" method="post" enctype="multipart/form-data">
                        <div>
                            <h5>Добавить платную подписку</h5>
                            <img src="" width="150" height="150" class="subLevelCover" id="mySubLevelCover">
                            <button type="button" class="btn btn-outline-secondary m-2" onclick="document.getElementById('subLevelCover').click()">Изменить обложку</button>
                            <input type='file' id="subLevelCover" style="display:none" asp-for="NewSubLevelDonationOption.CoverFile">
                        </div>
                        <div>
                            <label asp-for="NewSubLevelDonationOption.NewDonationOption.OptionName"></label>
                            <input class="form-control" asp-for="NewSubLevelDonationOption.NewDonationOption.OptionName" />
                        </div>
                        <div>
                            <label asp-for="NewSubLevelDonationOption.NewDonationOption.Description"></label>
                            <textarea class="form-control" asp-for="NewSubLevelDonationOption.NewDonationOption.Description"></textarea>
                        </div>
                        <div>
                            <label>Введите сумму подписки</label>
                            <input class="form-control" asp-for="NewSubLevelDonationOption.NewDonationOption.Price" />
                            <input type="hidden" asp-for="NewSubLevelDonationOption.NewDonationOption.MonetizationTypeId" value="@((int)Cactus.Models.Enums.MonetizationType.SubLevel)" />
                            <input type="hidden" asp-for="NewSubLevelDonationOption.NewDonationOption.AuthorId" value="@Convert.ToInt32(User.FindFirst("Id").Value)" />
                        </div>
                        <button class="btn btn-danger" type="submit">Сохранить</button>
                    </form>
                    <form asp-action="AddGoal" asp-controller="Monetization" method="post">
                        <div>
                            <h5>Добавить цель</h5>
                            <label asp-for="NewSubLevelDonationOption.NewDonationOption.OptionName"></label>
                            <input class="form-control" asp-for="NewSubLevelDonationOption.NewDonationOption.OptionName" />
                        </div>
                        <div>
                            <label asp-for="NewSubLevelDonationOption.NewDonationOption.Description"></label>
                            <textarea class="form-control" asp-for="NewSubLevelDonationOption.NewDonationOption.Description"></textarea>
                        </div>
                        <div>
                            <label>Введите сумму цели</label>
                            <input class="form-control" asp-for="NewSubLevelDonationOption.NewDonationOption.Price" />
                            <input type="hidden" asp-for="NewSubLevelDonationOption.NewDonationOption.MonetizationTypeId" value="@((int)Cactus.Models.Enums.MonetizationType.Goal)" />
                            <input type="hidden" asp-for="NewSubLevelDonationOption.NewDonationOption.AuthorId" value="@Convert.ToInt32(User.FindFirst("Id").Value)" />
                        </div>
                        <button class="btn btn-danger" type="submit">Сохранить</button>
                    </form>

                    <form asp-action="AddRemittance" asp-controller="Monetization" method="post">
                        <div>
                            <h5>Добавить перевод</h5>
                            <label asp-for="NewSubLevelDonationOption.NewDonationOption.OptionName"></label>
                            <input class="form-control" asp-for="NewSubLevelDonationOption.NewDonationOption.OptionName" />
                        </div>
                        <div>
                            <label asp-for="NewSubLevelDonationOption.NewDonationOption.Description"></label>
                            <textarea class="form-control" asp-for="NewSubLevelDonationOption.NewDonationOption.Description"></textarea>
                        </div>
                        <div>
                            <label>Введите минимальную сумму перевода</label>
                            <input class="form-control" asp-for="NewSubLevelDonationOption.NewDonationOption.Price" />
                            <input type="hidden" asp-for="NewSubLevelDonationOption.NewDonationOption.MonetizationTypeId" value="@((int)Cactus.Models.Enums.MonetizationType.Remittance)" />
                            <input type="hidden" asp-for="NewSubLevelDonationOption.NewDonationOption.AuthorId" value="@Convert.ToInt32(User.FindFirst("Id").Value)" />
                        </div>
                        <button class="btn btn-danger" type="submit">Сохранить</button>
                    </form>
                </div>
                @if (User.IsInRole("Author"))
                {
                    <div class="tab-pane fade" id="v-pills-Wallet" role="tabpanel" aria-labelledby="v-pills-Wallet-tab">
                        <h4>Пополнение кошелька</h4>
                        <div>
                            <form class="form-control" method="post" asp-controller="wallet" asp-action="replenishWallet">
                                <div>
                                    <input hidden asp-for="Replenish.Comission" />
                                    <label asp-for="Replenish.PayMethodId"></label>
                                    <select class="form-select" asp-for="Replenish.PayMethodId"
                                            asp-items="@(new SelectList(Model.PayMethods.Where(x => x.PayMethodSetting.TransactionTypeId == (int)Cactus.Models.Enums.TransactionType.Replenish), 
                                            nameof(Cactus.Models.Database.PayMethod.Id), 
                                            nameof(Cactus.Models.Database.PayMethod.Name)))">
                                        <option value="0" selected>Выберите метод пополнения</option>
                                    </select>
                                    <p class="m-1" id="payMethodLabel1"></p>
                                </div>
                                <label asp-for="Replenish.Sended"></label>
                                <div class="d-flex ">
                                    <input class="form-control" oninput="getReceived1()" asp-for="Replenish.Sended" />
                                    <nobr style="font-size: 20px">@Model.Wallet.Currency.Symbol</nobr>
                                </div>
                                <div>
                                    <label asp-for="Replenish.Received"></label>
                                    <input class="form-control" asp-for="Replenish.Received" />
                                </div>
                                <button class="btn btn-danger m-1" type="submit">Пополнить</button>
                            </form>
                        </div>
                        <hr/>
                        <h4>Вывод с кошелька</h4>
                        <div>
                            <form class="form-control" method="post" asp-controller="wallet" asp-action="WithdrawWallet">
                                <div>
                                    <input hidden asp-for="Withdraw.Comission"/>
                                    <label asp-for="Withdraw.PayMethodId"></label>
                                    <select class="form-select" asp-for="Withdraw.PayMethodId"
                                            asp-items="@(new SelectList(Model.PayMethods.Where(x => x.PayMethodSetting.TransactionTypeId == (int)Cactus.Models.Enums.TransactionType.Withdraw),
                                                nameof(Cactus.Models.Database.PayMethod.Id),
                                                nameof(Cactus.Models.Database.PayMethod.Name)))">
                                        <option value="0" selected>Выберите метод вывода</option>
                                    </select>
                                    <p class="m-1" id="payMethodLabel2"></p>
                                </div>
                                <label asp-for="Withdraw.Sended"></label>
                                <div class="d-flex ">
                                    <input class="form-control" oninput="getReceived2()" asp-for="Withdraw.Sended" />
                                    <nobr style="font-size: 20px">@Model.Wallet.Currency.Symbol</nobr>
                                </div>
                                <div>
                                    <label asp-for="Withdraw.Received"></label>
                                    <input class="form-control" asp-for="Withdraw.Received" />
                                </div>
                                <button class="btn btn-danger m-1" type="submit">Вывести</button>
                            </form>
                        </div>
                        <hr />

                        <div>
                            <a class="btn btn-secondary m-1" asp-controller="wallet" asp-action="Index">История пожертвований</a>
                        </div>
                        <div>
                            <a class="btn btn-secondary m-1" asp-controller="wallet" asp-action="History">
                                История пополнений/выводов
                            </a>
                        </div>
                    </div>
                }
            </div>
        </div>
        <div class="col">
            
        </div>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    function getReceived1() {
        if ($("#Replenish_PayMethodId").val() != 0) {
            var selectElement = document.getElementById("Replenish_Sended");
            var value = $("#Replenish_PayMethodId").val()
            var response = ajaxPayMethodId(value)
            document.getElementById("Replenish_Received").value = selectElement.value - selectElement.value / 100 * response;
            //document.getElementById("Replenish_Comission").value = response;
        }
    }

    function getReceived2() {
        if ($("#Withdraw_PayMethodId").val() != 0) {
            var selectElement = document.getElementById("Withdraw_Sended");
            var value = $("#Withdraw_PayMethodId").val()
            var response = ajaxPayMethodId(value)
            document.getElementById("Withdraw_Received").value = selectElement.value - selectElement.value / 100 * response;
            //document.getElementById("Withdraw_Comission").value = response;
        }
    }
</script>

<script type="text/javascript">
    $(function () {
        $("#Replenish_PayMethodId").change(function () {
            if ($("#Replenish_PayMethodId").val() != 0) {
                var value = $("#Replenish_PayMethodId").val()
                var response = ajaxPayMethodId(value)
                document.getElementById("payMethodLabel1").textContent = "Комиссия " + response + " %";
                document.getElementById("Replenish_Comission").value = response;
            }
        });
    });

    $(function () {
        $("#Withdraw_PayMethodId").change(function () {
            if ($("#Withdraw_PayMethodId").val() != 0) {
                var value = $("#Withdraw_PayMethodId").val()
                var response = ajaxPayMethodId(value)
                document.getElementById("payMethodLabel2").textContent = "Комиссия " + response + " %";
                document.getElementById("Withdraw_Comission").value = response;
            }
        });
    });

    function ajaxPayMethodId(value) {
        var res
        $.ajax({
            url: "@Url.ActionLink("SelectPaySetting", "Wallet")",
            type: 'POST',
            dataType: "json",
            async: false,
            data: { payMethodId: value },
            success: function (response) {
                res = response
            }
        });
        return res
    }
</script>